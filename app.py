# # app.py

# import streamlit as st
# from src.rag_pipeline import ChatbotPipeline
# import nest_asyncio  # <-- Th√™m d√≤ng n√†y

# nest_asyncio.apply() # <-- V√† th√™m d√≤ng n√†y
# # --- C·∫•u h√¨nh trang ---
# st.set_page_config(
#     page_title="Tr·ª£ l√Ω AI c·ªßa Anh Khoa",
#     page_icon="ü§ñ"
# )

# # --- State Management ---
# # Kh·ªüi t·∫°o chatbot pipeline v√† l∆∞u v√†o session state ƒë·ªÉ kh√¥ng ph·∫£i load l·∫°i
# # D√πng st.cache_resource ƒë·ªÉ cache l·∫°i resource n√†y
# @st.cache_resource
# def load_chatbot_pipeline():
#     return ChatbotPipeline()

# chatbot = load_chatbot_pipeline()

# # Kh·ªüi t·∫°o l·ªãch s·ª≠ chat
# if "messages" not in st.session_state:
#     st.session_state.messages = [{"role": "assistant", "content": "Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m hi·ªÉu g√¨ v·ªÅ Anh Khoa?"}]

# # --- Giao di·ªán ---
# st.title("ü§ñ Chatbot Portfolio c·ªßa Anh Khoa")
# st.caption("ƒê√¢y l√† m·ªôt tr·ª£ l√Ω AI ƒë∆∞·ª£c x√¢y d·ª±ng b·∫±ng RAG, c√≥ th·ªÉ tr·∫£ l·ªùi c√°c c√¢u h·ªèi v·ªÅ kinh nghi·ªám, k·ªπ nƒÉng v√† d·ª± √°n c·ªßa t√¥i.")

# # Hi·ªÉn th·ªã c√°c tin nh·∫Øn ƒë√£ c√≥
# for message in st.session_state.messages:
#     with st.chat_message(message["role"]):
#         st.markdown(message["content"])

# # X·ª≠ l√Ω input t·ª´ ng∆∞·ªùi d√πng
# if prompt := st.chat_input("H√£y h·ªèi t√¥i v·ªÅ c√°c d·ª± √°n ƒë√£ l√†m..."):
#     # Th√™m tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng v√†o l·ªãch s·ª≠
#     st.session_state.messages.append({"role": "user", "content": prompt})
#     # Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng
#     with st.chat_message("user"):
#         st.markdown(prompt)

#     # Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa tr·ª£ l√Ω
#     with st.chat_message("assistant"):
#         # Hi·ªÉn th·ªã spinner trong khi ch·ªù ph·∫£n h·ªìi
#         with st.spinner("ƒêang suy nghƒ©..."):
#             response = chatbot.get_response(prompt)
#             st.markdown(response)

#     # Th√™m tin nh·∫Øn c·ªßa tr·ª£ l√Ω v√†o l·ªãch s·ª≠
#     st.session_state.messages.append({"role": "assistant", "content": response})


# app_pretty.py
# A prettier Streamlit UI wrapper for your RAG chatbot

# __import__('pysqlite3')
# import sys
# sys.modules['sqlite3'] = sys.modules.pop('pysqlite3')

import streamlit as st
from datetime import datetime
from typing import List, Dict
import nest_asyncio

# RAG pipeline
from src.rag_pipeline import ChatbotPipeline

# ---- Patch nested event loops (Jupyter/Streamlit) ----
nest_asyncio.apply()
import time
import random


# -------------------- SPAM/CAPTCHA Logic --------------------
def initialize_spam_protection():
    """Kh·ªüi t·∫°o c√°c bi·∫øn c·∫ßn thi·∫øt trong session state."""
    if 'require_captcha' not in st.session_state:
        st.session_state.require_captcha = False
    if 'request_timestamps' not in st.session_state:
        st.session_state.request_timestamps = []

def check_rate_limit(max_requests: int, per_seconds: int) -> bool:
    """Ki·ªÉm tra rate limit. N·∫øu vi ph·∫°m, k√≠ch ho·∫°t CAPTCHA."""
    current_time = time.time()
    st.session_state.request_timestamps = [
        ts for ts in st.session_state.request_timestamps
        if current_time - ts < per_seconds
    ]

    if len(st.session_state.request_timestamps) >= max_requests:
        st.session_state.require_captcha = True # K√≠ch ho·∫°t CAPTCHA
        return False

    st.session_state.request_timestamps.append(current_time)
    return True

def generate_captcha():
    """T·∫°o c√¢u h·ªèi to√°n h·ªçc m·ªõi."""
    st.session_state.num1 = random.randint(1, 10)
    st.session_state.num2 = random.randint(1, 10)
    st.session_state.captcha_answer = st.session_state.num1 + st.session_state.num2

def captcha_check():
    """Ki·ªÉm tra c√¢u tr·∫£ l·ªùi v√† t·∫Øt CAPTCHA n·∫øu ƒë√∫ng."""
    user_answer = st.session_state.get('captcha_input', '')
    if user_answer.isdigit() and int(user_answer) == st.session_state.captcha_answer:
        st.session_state.require_captcha = False # T·∫Øt CAPTCHA
        st.success("X√°c minh th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c tr√≤ chuy·ªán.")
        # X√≥a c√°c bi·∫øn kh√¥ng c·∫ßn thi·∫øt
        del st.session_state.num1
        del st.session_state.num2
        del st.session_state.captcha_answer
        time.sleep(2) # Ch·ªù 2 gi√¢y ƒë·ªÉ ng∆∞·ªùi d√πng ƒë·ªçc th√¥ng b√°o
        st.rerun()
    else:
        st.error("C√¢u tr·∫£ l·ªùi kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.")
        generate_captcha() # T·∫°o c√¢u h·ªèi m·ªõi

# -------------------- Page Config --------------------
st.set_page_config(
    page_title="Tr·ª£ l√Ω AI c·ªßa Anh Khoa",
    page_icon="ü§ñ",
    layout="wide"
)

# -------------------- Custom CSS ---------------------
CUSTOM_CSS = """
<style>
/* widen content and tweak fonts */
.main .block-container {max-width: 1100px; padding-top: 1.2rem;}
/* hero section */
.hero {
  padding: 1.25rem 1.25rem;
  border-radius: 16px;
  background: linear-gradient(135deg, rgba(33,150,243,0.08), rgba(250,130,28,0.08));
  border: 1px solid rgba(127,127,127,0.15);
  margin-bottom: 1rem;
}
.hero h1 {
  font-size: 2rem;
  margin: 0 0 .25rem 0;
}
.hero p {
  margin: 0;
  opacity: .85;
}

/* chat bubbles */
.stChatMessage[data-testid="stChatMessage"] {
  border-radius: 14px;
  padding: .6rem .75rem;
  margin-bottom: .5rem;
  border: 1px solid rgba(127,127,127,0.15);
}
.stChatMessage[data-testid="stChatMessage"] [data-testid="stMarkdownContainer"] p {
  margin-bottom: .6rem;
}
/* assistant bubble tint */
.stChatMessage:nth-child(odd) {
  background: rgba(33,150,243,0.05);
}
/* user bubble tint */
.stChatMessage:nth-child(even) {
  background: rgba(250,130,28,0.06);
}

/* chip buttons */
.chips button[kind="secondary"] {
  border-radius: 999px !important;
  padding: .25rem .75rem !important;
  margin-right: .35rem !important;
  margin-bottom: .35rem !important;
}

/* small caption row */
.meta-row {
  font-size: .85rem;
  opacity: .8;
}

/* sidebar card */
.sidebar-card {
  padding: .75rem;
  border-radius: 14px;
  border: 1px solid rgba(127,127,127,0.15);
  background: rgba(0,0,0,0.02);
}
.sidebar-card h4 {
  margin-top: 0;
  margin-bottom: .5rem;
}
</style>
"""
st.markdown(CUSTOM_CSS, unsafe_allow_html=True)

# -------------------- Helpers --------------------
def ensure_session():
    if "messages" not in st.session_state:
        st.session_state.messages: List[Dict[str, str]] = [
            {"role": "assistant", "content": "Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m hi·ªÉu g√¨ v·ªÅ Anh Khoa?"}
        ]
    if "suggestions" not in st.session_state:
        st.session_state.suggestions = [
            "Show my projects using Next.js",
            "What did I do at Cyno Software?",
            "List my experience timeline",
            "Which projects use PostgreSQL?",
            "Give a short bio based on my CV"
        ]

def append_message(role: str, content: str):
    st.session_state.messages.append({"role": role, "content": content})

def run_query(chatbot: "ChatbotPipeline", user_text: str) -> str:
    # Keep the app resilient if your pipeline raises.
    try:
        return chatbot.get_response(user_text)
    except Exception as e:
        return f"‚ùå Error from pipeline: `{e}`"

# -------------------- Cache RAG pipeline --------------------
@st.cache_resource
def load_chatbot_pipeline():
    return ChatbotPipeline()

chatbot = load_chatbot_pipeline()
ensure_session()
initialize_spam_protection()
# -------------------- Sidebar --------------------
with st.sidebar:
    st.image("https://kflower.me/images/avatar.png", caption="Nguyen Anh Khoa", use_container_width=True)
    st.markdown("""
<div class="sidebar-card">
<h4>About</h4>
<b>Role:</b> Full-Stack / Front-End developer<br/>
<b>Focus:</b> Next.js, React, Node.js, PostgreSQL<br/>
<b>Location:</b> Ho Chi Minh City, Vietnam
</div>
""", unsafe_allow_html=True)

    st.markdown("---")
    st.markdown("#### Quick actions")
    col1, col2 = st.columns(2)
    if col1.button("üßπ New chat"):
        st.session_state.messages = [{"role": "assistant", "content": "B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi. B·∫°n mu·ªën h·ªèi g√¨ v·ªÅ h·ªì s∆° c·ªßa t√¥i?"}]
        st.rerun()
    st.download_button(
        "‚¨áÔ∏è Export chat",
        data="\n\n".join([f"**{m['role']}**: {m['content']}" for m in st.session_state.messages]).encode("utf-8"),
        file_name=f"chat_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md",
        mime="text/markdown"
    )

    st.markdown("---")
    st.markdown("#### Links")
    st.link_button("üåê Portfolio", "https://akflower.vercel.app")
    st.link_button("üíº LinkedIn", "https://www.linkedin.com/in/akflower")
    st.link_button("üìÇ GitHub", "https://github.com/AKflower")

# -------------------- Header / Hero --------------------
st.markdown("""
<div class="hero">
  <h1>ü§ñ Chatbot Portfolio ‚Äî Nguyen Anh Khoa</h1>
  <p>This assistant uses a RAG pipeline to answer questions about my experiences, skills, and projects.</p>
</div>
""", unsafe_allow_html=True)

# -------------------- Suggestion Chips --------------------
with st.container():
    st.caption("Try one of these:")
    cols = st.columns(5)
    for i, sug in enumerate(st.session_state.suggestions[:5]):
        if cols[i].button(sug, key=f"sug_{i}", type="secondary"):
            # Simulate user message from chip
            append_message("user", sug)
            with st.chat_message("user", avatar="üßë‚Äçüíª"):
                st.markdown(sug)

            with st.chat_message("assistant", avatar="ü§ñ"):
                with st.spinner("Thinking..."):
                    resp = run_query(chatbot, sug)
                    st.markdown(resp)
            append_message("assistant", resp)
            st.stop()

# -------------------- Chat History --------------------
for message in st.session_state.messages:
    avatar = "ü§ñ" if message["role"] == "assistant" else "üßë‚Äçüíª"
    with st.chat_message(message["role"], avatar=avatar):
        st.markdown(message["content"])



if st.session_state.require_captcha:
    st.warning("B·∫°n ƒë√£ g·ª≠i y√™u c·∫ßu qu√° nhanh. Vui l√≤ng x√°c minh b·∫°n l√† ng∆∞·ªùi th·∫≠t ƒë·ªÉ ti·∫øp t·ª•c.")

    if 'num1' not in st.session_state:
        generate_captcha()

    st.write(f"Vui l√≤ng tr·∫£ l·ªùi c√¢u h·ªèi sau: **{st.session_state.num1} + {st.session_state.num2} = ?**")

    st.text_input(
        "Nh·∫≠p c√¢u tr·∫£ l·ªùi v√† nh·∫•n Enter:",
        key="captcha_input",
        on_change=captcha_check
    )

# -------------------- Chat Input --------------------
prompt_disabled = st.session_state.require_captcha

if prompt := st.chat_input("Ask me about my work, skills, or projects..."):
    if check_rate_limit(max_requests=5, per_seconds=30):
        append_message("user", prompt)
        with st.chat_message("user", avatar="üßë‚Äçüíª"):
            st.markdown(prompt)

        with st.chat_message("assistant", avatar="ü§ñ"):
            with st.spinner("Thinking..."):
                response = run_query(chatbot, prompt)
                st.markdown(response)

        append_message("assistant", response)
        st.rerun() # Ch·∫°y l·∫°i ƒë·ªÉ x√≥a input sau khi g·ª≠i
    else:
        st.rerun() # Ch·∫°y l·∫°i ƒë·ªÉ hi·ªÉn th·ªã CAPTCHA


# -------------------- Footer --------------------
st.markdown(
    '<div class="meta-row">Made with ‚ù§Ô∏è using Streamlit ¬∑ Last updated: '
    + datetime.now().strftime("%Y-%m-%d %H:%M")
    + "</div>",
    unsafe_allow_html=True,
)
